# Elasticsearch

Elasticsearch 是一个基于 Lucene 搜索引擎为核心构建的搜索服务器，它提供了一个分布式多用户能力的全文搜索引擎。
Elasticsearch 是用 Java 开发的，并作为Apache 许可条款下的开放源码发布，提供了 RESTful API 和各种语言的 SDK。
Elasticsearch 入门非常容易，它发布的时候设置了很多合理的默认值使初学者避开了那些复杂的搜素理论，能够立刻工作，即使对搜索没什么了解的人，也能使用它实现很多功能。

如果直接基于 Lucene 开发，非常复杂，即便写一些简单的功能，也要写大量的 Java 代码，需要深入理解原理。用 Elasticsearch 则会很简单，类似的 Solr 也是基于 Lucene 实现的。

Elasticsearch 不仅仅是 Lucene 和全文搜索，我们还能这样去描述它：

- 分布式的实时文件存储，每个字段都被索引并可被搜索
- 分布式的实时分析搜索引擎
- 可以扩展到上百台服务器，处理 PB 级结构化或非结构化数据

## 核心概念

### 接近实时 Near Realtime

Elasticsearch是一个接近实时的搜索平台。这意味着，从索引一个文档直到这个文档能够被搜索到有一个轻微的延迟（通常是1秒）。

### 集群 Cluster

一个集群由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。
一个集群由一个唯一的名字标识，默认名字是`elasticsearch`。一个节点只能通过指定某个集群的名字，来加入这个集群。
在产品环境中显式地设定这个名字是一个好习惯，但是使用默认值来进行开发/测试也是不错的。

### 节点 Node

一个节点是集群中的一个服务器，作为集群的一部分，用于存储数据，参与集群的索引和搜索功能。在一个集群里，可以拥有任意多个节点。
一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个名为`elasticsearch`的集群中，
这意味着，如果启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做`elasticsearch`的集群中。
而且，如果当前网络中没有运行任何节点，这时启动一个节点，会默认创建并加入一个名为`elasticsearch`的集群。

### 索引 Index

一个索引就是一个拥有几分相似特征的文档的集合。在一个集群中，可以定义任意多的索引。例如，可以有一个用户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。
一个索引由一个名字来标识（必须全部是小写字母的），当对某个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。

### 类型 Type

在一个索引中，可以定义一种或多种类型。一个类型是索引的一个逻辑上的分类/分区，其语义完全由业务来定。通常，会为具有一组共同字段的文档定义一个类型。
例如，商品可以分为日用商品、电器商品、生鲜商品等，且每个商品对应的文档的字段可以不一样。

类型在 ElasticSearch 7 版本中已经被弃用，将在 ElasticSearch 8 版本中被彻底移除。

[Removal of mapping types](https://github.com/elastic/elasticsearch/blob/6.5/docs/reference/mapping/removal_of_types.asciidoc)

> Indices created in Elasticsearch 6.0.0 or later may only contain a single mapping type.  
> Indices created in 5.x with multiple mapping types will continue to function as before in Elasticsearch 6.x.  
> Types will be deprecated in APIs in Elasticsearch 7.0.0, and completely removed in 8.0.0.

为什么要删除映射类型：

> 最初，我们谈到索引`index`类似于数据库中的数据库`database`，类型`type`相当于表`table`。
>
> 这是一个糟糕的类比，导致了错误的假设。在数据库中，表是相互独立的。一个表中的列与另一个表中的同名列无关。对于映射类型中的字段，情况并非如此。
>
> 在 Elasticsearch 索引中，不同映射类型中具有相同名称的字段在内部由相同的 Lucene 字段支持。并且相同名称的字段在多种类型中必须具有相同的映射（定义）。
>
> 例如，当您希望 delete 成为同一索引中一种类型的日期字段和另一种类型的布尔字段时，这可能会导致挫败感。
>
> 最重要的是，在同一索引中存储具有很少或没有共同字段的不同实体会导致数据稀疏并干扰 Lucene 有效压缩文档的能力。
>
> 由于这些原因，我们决定从 Elasticsearch 中删除映射类型的概念。

### 文档 Document

一个文档是一个可被索引的基础信息单元，文档以 JSON 数据格式来表示，而 JSON 是一个到处存在的互联网数据交互格式。在一个索引里，可以存储任意多的文档。

### 分片 Shard

一个索引可以存储超出单个结点硬件限制的大量数据。例如，一个具有 10 亿文档的索引占据 1TB 的磁盘空间，而任一节点都没有这样大的磁盘空间，或者单个节点处理搜索请求，响应太慢。
为了解决这个问题，Elasticsearch 提供了将索引划分成多份的能力，这就叫做分片。

分片可以分为主分片（Primary Shard）和复制分片（Replica Shard）。

### 复制 Replica

在一个网络的环境里，失败随时都可能发生，某个分片/节点发生崩溃故障，这种情况下，通过故障转移机制可以保证数据不丢失和系统稳定。
为此目的，Elasticsearch 允许创建分片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。

## 分布式架构

## 工作原理

## 生产问题

### 数据量很大的情况下如何提高查询效率

### 生产部署架构
