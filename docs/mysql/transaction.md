# 事务的基本特性和隔离级别

## ACID

是指数据库管理系统（DBMS）在写入或更新资料的过程中，为保证事务（Transaction）是正确可靠的，所必须具备的四个特性：

- 原子性（Atomicity）：整个事务中的所有操作，要么全部完成，要么全部不完成，不可能停滞在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态。
- 一致性（Consistency）：在事务开始之前和事务结束以后，数据库的完整性约束没有被破坏。
- 隔离性（Isolation）：一个事务的执行不能其它事务干扰。即一个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务之间不能互相干扰。
- 持久性（Durability）：在事务完成以后，该事务所对数据库所作的更改便持久的保存在数据库之中，并不会被回滚。

## 并发事务处理带来的问题

- 更新丢失（Lost Update）：事务A和事务B选择同一行，然后基于最初选定的值更新该行时，由于两个事务都不知道彼此的存在，就会发生丢失更新问题。
- 脏读（Dirty Reads）：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据。
- 不可重复读（Non-Repeatable Reads）：事务 A 多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果不一致。
- 幻读（Phantom Reads）：幻读与不可重复读类似。它发生在一个事务A读取了几行数据，接着另一个并发事务B插入了一些数据时。在随后的查询中，事务A就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。

“更新丢失”通常是应该完全避免的。但防止更新丢失，并不能单靠数据库事务控制器来解决，需要应用程序对要更新的数据加必要的锁来解决，因此，防止更新丢失应该是应用的责任。

“脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决：

- 加锁（Locking）：在读取数据前，对其加锁，阻止其他事务对数据进行修改。
- 多版本并发控制（MultiVersion Concurrency Control，简称 MVCC）：不用加任何锁，通过一定机制生成一个数据请求时间点的一致性数据快照（Snapshot)，并用这个快照来提供一定级别（语句级或事务级）的一致性读取。从用户的角度来看，好象是数据库可以提供同一数据的多个版本。

## 隔离级别

数据库事务的隔离级别有4种，由低到高分别为

- 读未提交（READ-UNCOMMITTED）：最低的隔离级别，允许读取尚未提交的数据变更，可能会导致脏读、幻读或不可重复读。
- 读已提交（READ-COMMITTED）：允许读取并发事务已经提交的数据，可以阻止脏读，但是幻读或不可重复读仍有可能发生。
- 可重复读（REPEATABLE-READ）：对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，可以阻止脏读和不可重复读，但幻读仍有可能发生。
- 可串行化（SERIALIZABLE）：最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，该级别可以防止脏读、不可重复读以及幻读。

查看当前数据库的事务隔离级别：`show variables like 'transaction_isolation'`

## 多版本并发控制

InnoDB中通过Undo Log实现了数据的多版本，而并发控制通过锁来实现。

InnoDB行记录中有两个隐藏字段`trx_id`和`db_roll_ptr`，`trx_id`表示最近修改的事务的`id`，`db_roll_ptr`指向Undo Segment中的Undo Log。

_MVCC 只在读已提交（READ-COMMITTED）和可重复读（REPEATABLE-READ）两种隔离级别下工作。_

## Redo Log

Redo Log记录了数据操作在物理层面的修改，MySQL中使用了大量缓存，缓存存在于内存中，修改操作时会直接修改内存，而不是立刻修改磁盘。

当内存和磁盘的数据不一致时，称内存中的数据为脏页(Dirty Page)。为了保证数据的安全性，事务进行中时会不断的产生Redo Log，在事务提交时进行一次flush操作时保存到磁盘中。

Redo Log是按照顺序写入的，磁盘的顺序读写的速度远大于随机读写。当数据库或主机失效重启时，会根据Redo Log进行数据的恢复，如果Redo Log中有事务提交，则进行事务提交修改数据。这样实现了事务的原子性、一致性和持久性。

## Undo Log

除了记录Redo Log外，当进行数据修改时还会记录Undo Log。

Undo Log用于数据的撤回操作，它记录了修改的反向操作，比如，插入对应删除，修改对应修改为原来的数据，通过Undo Log可以实现事务回滚，并且可以根据Undo Log回溯到某个特定的版本的数据，实现MVCC。

## Binary Log

Binary Log，是MySQL服务层产生的日志，常用来进行数据恢复、数据库复制，常见的MySQL主从架构，就是采用slave同步master的Binary Log实现的, 另外通过解析Binary Log能够实现MySQL到其他数据源的数据复制，如：Elasticsearch、Redis等。
