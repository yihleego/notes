# 列存索引

## OLAP 和 OLTP

### OLTP（Online Transaction Processing，联机事务处理）

- 定义：主要用于日常的事务处理系统，比如银行转账、订单处理、库存管理等。
- 特点：
    - 面向事务：每个操作都是一个完整的事务（如插入、更新、删除）。
    - 响应速度快：需要在毫秒级完成，因为直接面向用户。
    - 数据量大但每次处理数据量小：比如一次转账只涉及几条记录。
    - 数据一致性要求极高：需要严格遵循 ACID 原则（原子性、一致性、隔离性、持久性）。
- 应用场景：银行系统、电商下单、库存系统、ATM 取款机等。

### OLAP（Online Analytical Processing，联机分析处理）

- 定义：主要用于对大量历史数据进行多维度分析，支持复杂查询和决策支持。
- 特点：
    - 面向分析：执行复杂的查询和统计分析。
    - 响应时间相对较长：一次查询可能涉及上百万甚至上亿条记录。
    - 数据量大：通常来自多个 OLTP 系统汇总后的数据仓库。
    - 不强调事务一致性，而是更关注查询的准确性和全面性。
- 应用场景：商业智能（BI）、报表系统、数据仓库、销售分析、市场预测。

### 二者区别总结

| 对比点   | OLTP          | OLAP       |
|-------|---------------|------------|
| 主要用途  | 事务处理          | 数据分析       |
| 操作类型  | 插入、更新、删除      | 查询、聚合      |
| 响应时间  | 毫秒级           | 秒级到分钟级     |
| 数据量   | 单次处理少量数据      | 批量处理海量数据   |
| 数据一致性 | 必须强一致性 (ACID) | 可以稍微放宽     |
| 应用场景  | 银行、电商、ERP     | BI、报表、数据仓库 |

## 列存储索引 Columnstore Index

Columnstore Index（列存储索引）是 数据库系统中提供的一种数据存储与索引方式，它特别适合大规模数据分析型场景。与传统的 行存储索引（Rowstore Index） 不同，它以 列为单位 存储和压缩数据。
这种设计非常适合 OLAP（联机分析处理）场景，例如数据仓库和大规模分析查询。

### 一、概念与背景

Columnstore Index 是一种面向列（Column-Oriented）的存储和索引方式，与传统的 Rowstore（行存储）索引相对。

行存储（Rowstore）：以行为单位存储，适合频繁的 OLTP（联机事务处理），例如银行转账、订单系统等。

列存储（Columnstore）：以列为单位存储，更适合 OLAP（联机分析处理），即大数据量的统计、聚合和分析。

这种索引方式最初由 VertiPaq（PowerPivot 引擎） 在 Microsoft 的 BI 工具中引入，随后在 SQL Server 2012 中首次作为 Columnstore Index 提供。

### 二、核心原理

1. 列式存储
    - 每一列的数据会被单独存储，而不是整行存储。
    - 对于分析型查询（如 SELECT SUM(Sales) FROM Orders），只需扫描相关列（Sales 列），极大减少 IO。
2. 批处理执行（Batch Mode Execution）
    - SQL 引擎可以一次处理一组数据行（例如 1,000 行），相比传统逐行处理，效率大幅提升。
3. 数据压缩
    - 同一列的数据通常类型一致且重复度高（例如 “性别”“省份”），压缩率非常高（常见 10x~100x）。
    - 使用 字典编码、位图编码、增量编码等压缩算法。
4. 段与字典
    - 数据被切分为 row group（行组，通常 1 百万行）。
    - 每个 row group 中的列被进一步压缩，并使用 column segment 存储。
    - 字典存储常见值，加快压缩与查询。

### 三、Columnstore Index 的类型

1. 非聚集列存储索引（Nonclustered Columnstore Index，NCCI）
    - 可以在行存储表上额外创建，索引仅覆盖部分或全部列。
    - 常见于混合型工作负载（既有事务也有分析）。
2. 聚集列存储索引（Clustered Columnstore Index，CCI）
    - 整个表的数据以列存储方式保存。
    - 常见于 数据仓库表、大规模事实表。

### 四、优缺点

优点：

- 查询性能极高：尤其在大数据聚合、过滤、分组、排序时。
- 存储空间节省：高压缩率节省存储和 IO。
- 并行处理友好：适合现代多核、多线程 CPU 架构。

缺点：

- 写入代价较高：列存储不擅长频繁的 INSERT/UPDATE/DELETE。
- 延迟更新：数据可能先进入 Delta Store（行存储区），再批量压缩到列存储。
- 不适合 OLTP：适合读多写少的场景。

### 五、应用场景

- 数据仓库、数据集市
- 日志分析、实时报表
- 大数据聚合计算（如销售额统计、用户行为分析）

### 六、最佳实践

- 混合负载：OLTP 表可建 NCCI，OLAP 表使用 CCI。
- 分区表结合列存储：适合分区数据仓库场景。
- 避免频繁更新：减少对 Columnstore Index 的行级 DML 操作。
- 利用批模式执行：配合并行执行计划，充分利用硬件资源。
